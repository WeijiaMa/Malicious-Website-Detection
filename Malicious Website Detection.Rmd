---
title: "Final Project"
author: "Weijia Ma and Rosa Zhu"
date: "5/17/2018"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
set.seed(1)
library(ggformula)
library(gridExtra)
library(broom)
library(dplyr)
library(tidyr)
library(stringr)
library(car)
library(GGally)
library(pander)
library(purrr)
library(MASS)
library(effects)
```



# Load Dataset
```{r}
website <- read.csv("~/Desktop/Malicious-Website-Detection/benign_or_malicious_website.csv")
```


# Data Wrangling and Cleaning on Categorical Predictors
```{r}
# upper case
website <- website %>% mutate_if(is.factor, toupper)
website <- website %>% mutate_if(is.character, as.factor)
# omitting NA values in the dataset
website <- na.omit(website)
# getting rid of WHOIS_STATEPRO and URL
website <- website %>% 
  dplyr::select(-c(WHOIS_STATEPRO, URL))
# simplify SERVER
website <- website %>% 
  mutate(SERVER = str_replace_all(SERVER, pattern = "APACHE.*", "APACHE")) %>%
  mutate(SERVER = str_replace_all(SERVER, pattern = "MICROSOFT.*", "MICROSOFT")) %>%
  mutate(SERVER = str_replace_all(SERVER, pattern = "ATS.*", "ATS")) %>%
  mutate(SERVER = str_replace_all(SERVER, pattern = "NGINX.*", "NGINX")) %>%
  mutate(SERVER = factor(SERVER))
# main SERVER
main.server <- c("APACHE", "GSE", "MICROSOFT", "NGINX", "NONE")
# wrong SERVER
wrong.server <- c("XXXXXXXXXXXXXXXXXXXXXX", "YIPPEE-KI-YAY", "WWW.LEXISNEXIS.COM  9999", "SERVER")
# combine wrong and main SERVER
server.comb <- combine(main.server, wrong.server)
# simplify SERVER, all values not in main server or wrong server lists are set to be "OTHER", 
# values in wrong server lists are set to be "SUSPICIOUS"
website <- website %>% 
  mutate(SERVER = as.factor(ifelse(SERVER %in% server.comb, as.character(SERVER), "OTHER"))) %>%
  mutate(SERVER = as.factor(ifelse(SERVER %in% wrong.server, "SUSPICIOUS", as.character(SERVER))))
# simplify WHOIS_COUNTRY
website <- website %>% 
  mutate(WHOIS_COUNTRY = str_replace_all(WHOIS_COUNTRY, ".*UK.*", "UK")) %>%
  mutate(WHOIS_COUNTRY = str_replace_all(WHOIS_COUNTRY, "UNITED KINGDOM", "UK")) %>%
  mutate(WHOIS_COUNTRY = str_replace_all(WHOIS_COUNTRY, "GB", "UK")) %>%
  mutate(WHOIS_COUNTRY = factor(WHOIS_COUNTRY))
main.country <- c("UK", "US", "CA", "NONE")
website <- website %>% 
  mutate(WHOIS_COUNTRY = as.factor(ifelse(WHOIS_COUNTRY %in% main.country, as.character(WHOIS_COUNTRY), "OTHER")))
# simplify CHARSET
website <- website %>% 
  mutate(CHARSET = str_replace_all(CHARSET, pattern = "ISO-8859.*", "ISO-8859")) %>%
  mutate(CHARSET = str_replace_all(CHARSET, pattern = "WINDOWS.*", "WINDOWS")) %>%
  mutate(CHARSET = as.factor(CHARSET))
```

```{r}
# simplify WHOIS_REGDATE
website <- website %>%
  mutate(WHOIS_REGDATE = as.Date(WHOIS_REGDATE, format = ifelse(grepl("T", as.Date(WHOIS_REGDATE)), "%Y-%m-%dT", "%d/%m/%Y"))) %>% 
  mutate(WHOIS_REGDATE = as.numeric(difftime(WHOIS_REGDATE, as.Date("1990-07-26"), units = "days"))) %>%
  mutate(NA_REGDATE = as.factor(ifelse(is.na(WHOIS_REGDATE), 1, 0))) 
mean.reg.date <- mean(website$WHOIS_REGDATE, na.rm = TRUE)
website <- website %>%
  mutate(WHOIS_REGDATE = ifelse(is.na(WHOIS_REGDATE), mean.reg.date, WHOIS_REGDATE))
# simplify WHOIS_UPDATED_DATE
website <- website %>%
  mutate(WHOIS_UPDATED_DATE = as.Date(WHOIS_UPDATED_DATE, format = ifelse(grepl("T", WHOIS_UPDATED_DATE), "%Y-%m-%dT", "%d/%m/%Y"))) %>%
  mutate(WHOIS_UPDATED_DATE = as.numeric(difftime(WHOIS_UPDATED_DATE, as.Date("2008-07-14"), units = "days"))) %>%
  mutate(NA_UPDATED_DATE = as.factor(ifelse(is.na(WHOIS_UPDATED_DATE), 1, 0)))
mean.update.date <- mean(na.omit(website$WHOIS_UPDATED_DATE))
website <- website %>%
  mutate(WHOIS_UPDATED_DATE = ifelse(is.na(WHOIS_UPDATED_DATE), mean.update.date, WHOIS_UPDATED_DATE))
# factor Type
website <- website %>% mutate(Type = as.factor(Type))
website.sm <- website %>%
  mutate(WHOIS_REGDATE = ifelse(is.na(WHOIS_REGDATE), mean.reg.date, WHOIS_REGDATE))
```
  
# EDA

```{r}
# histograms
#ggpairs(website.quant)
# App Packets & Bytes
#ggpairs(website[, 12:17])
gf_boxplot(APP_BYTES ~ Type, data = website)

# Quantatative
# select quantitative vars
website.quant <- website %>% 
  dplyr::select(-c(SERVER, WHOIS_COUNTRY, CHARSET))
website.quant %>%
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram()

# Charset
website %>% gf_bar(~CHARSET, fill=~Type)
table(website$CHARSET, website$Type) %>% prop.table(margin=1)

# SERVER
website %>% gf_bar(~SERVER, fill=~Type)
table(website$SERVER, website$Type) %>% prop.table(margin=1)

# REGDATE
gf_boxplot(WHOIS_REGDATE ~ Type, data = website)

# log transform
emplog <- function(x) { return (log(x+0.5)) }
#website <- website%>%
  #mutate(WHOIS_REGDATE = as.character(WHOIS_REGDATE)) %>% 
  #mutate_if(is.numeric, emplog) %>%
  #mutate(WHOIS_REGDATE = as.numeric(WHOIS_REGDATE))
```

# Fit Model for Inference
## Fit Full Model & Outlier Detection & Model Assumption Checking
```{r}
website <-website %>%
  mutate(WHOIS_COUNTRY = relevel(WHOIS_COUNTRY, ref = "NONE"))
inf.mod.full <- glm(Type ~ . , data = website, family = binomial)
str(website)
summary(inf.mod.full)
influenceIndexPlot(inf.mod.full, vars = c("Cook", "Studentized", "hat"))
residualPlots(inf.mod.full)
```

```{r}
website <- website [-c(443,898, 468,897,671,72,558),]
inf.mod.no.outlier <- glm(Type ~ . , data = website, family = binomial)
influenceIndexPlot(inf.mod.no.outlier, vars = c("Cook", "Studentized", "hat"))
residualPlots(inf.mod.no.outlier)
```

## Model Selection
```{r fig.height=9, fig.width=12}
# Multicollinearity (PACKETS & BYTES)
inf.mod.bytes <- update(inf.mod.no.outlier, . ~ . - (REMOTE_APP_PACKETS + SOURCE_APP_PACKETS +  REMOTE_APP_BYTES + APP_PACKETS + APP_BYTES))
anova(inf.mod.bytes, inf.mod.no.outlier, test = "Chisq")
# Stepwise
inf.mod.aic <- stepAIC(inf.mod.bytes,
                           scope = list(lower ~ 1),
                           direction = "both",
                           trace = 0)
summary(inf.mod.aic)
influenceIndexPlot(inf.mod.aic, vars = c("Cook", "Studentized", "hat"))
crPlots(inf.mod.aic)
plot(allEffects(inf.mod.aic, title=""), rows = 3, cols = 4, main="")
```


## Interpretation
```{r}
pander(100*exp(coef(inf.mod.aic)))
```

# Fit Model for Prediction
```{r}

```

 
## Create Training and Test Datasets
```{r}
index <- sample(1:nrow(website), size=0.2*nrow(website))
website.train <- website[-index, ]
website.test <- website[index, ]
```

## Fit Model
```{r}
pred.mod.full <- glm(Type ~ . , data = website.train, family = binomial)
summary(pred.mod.full)

pred.mod.no.packet <- update(pred.mod.full, . ~ . - (REMOTE_APP_PACKETS + SOURCE_APP_PACKETS +  REMOTE_APP_BYTES + APP_PACKETS + APP_BYTES))
summary(pred.mod.no.packet)
```

## Prediction
```{r}
pred.full <- predict(pred.mod.full, newdata = website.test, type = "response")
website.test <- website.test %>% mutate(pred.full = as.factor(ifelse(pred.full <= 0.5, 0, 1)))
accuracy.full <- mean(website.test$pred.full == website.test$Type)
```

# Fit Quantatative Model

```{r}
# training / test set split for dataset with quantitative predictors only
index <- sample(1:nrow(website.quant), size=0.2*nrow(website.quant))
website.train.quant <- website.quant[-index, ]
website.test.quant <- website.quant[index, ]

# glm
pred.mod.quant <- glm(Type ~ . , data = website.train.quant, family = binomial)
summary(pred.mod.quant)
pred.mod.quant.signif <- glm(Type ~ URL_LENGTH + NUMBER_SPECIAL_CHARACTERS + CONTENT_LENGTH + DIST_REMOTE_TCP_PORT, 
                        data = website.train.quant, family = binomial)
summary(pred.mod.quant.signif)
residualPlots(pred.mod.quant.signif)

# predict
pred.quant.signif <- predict(pred.mod.quant.signif, newdata = website.test.quant, type = "response")
website.test <- website.test.quant %>% mutate(pred.quant.signif = as.factor(ifelse(pred.quant.signif <= 0.5, 0, 1)))
accuracy.quant.signif <- mean(website.test.quant$pred.quant.signif == website.test$Type)
```

