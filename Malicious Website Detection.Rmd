---
title: "Final Project"
author: "Weijia Ma and Rosa Zhu"
date: "5/17/2018"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(1)
library(ggformula)
library(gridExtra)
library(broom)
library(dplyr)
library(tidyr)
library(stringr)
library(car)
library(GGally)
library(pander)
library(purrr)
website.full <- read.csv("~/Desktop/Malicious-Website-Detection/benign_or_malicious_website.csv")
```


# datasets
```{r}
website.full <- website.full %>% mutate(Type = as.factor(Type))
# upper case
website.full <- website.full %>% mutate_if(is.factor, toupper)
website.full <- website.full %>% mutate_if(is.character, as.factor)
# omit na
website.na <- na.omit(website.full)
# select quantitative vars
website.quant <- website.na %>% dplyr::select(-c(URL, SERVER, WHOIS_COUNTRY, WHOIS_STATEPRO, WHOIS_REGDATE, WHOIS_UPDATED_DATE))
# training / test set split
index <- sample(1:nrow(website.quant), size=0.2*nrow(website.quant))
website.train <- website.quant[-index, ]
website.test <- website.quant[index, ]
```

```{r}
# Data Wrangling Section, the resulting data set contains simplified categorical predictors.

# omitting NA values in the dataset
website <- na.omit(website.full)
# getting rid of WHOIS_STATEPRO and URL
website <- website %>% 
  dplyr::select(-c(WHOIS_STATEPRO, URL))
# simplify SERVER
website <- website %>% 
  mutate(SERVER = str_replace_all(SERVER, pattern = "APACHE.*", "APACHE")) %>%
  mutate(SERVER = str_replace_all(SERVER, pattern = "MICROSOFT.*", "MICROSOFT")) %>%
  mutate(SERVER = str_replace_all(SERVER, pattern = "ATS.*", "ATS")) %>%
  mutate(SERVER = str_replace_all(SERVER, pattern = "NGINX.*", "NGINX")) %>%
  mutate(SERVER = factor(SERVER))
# main SERVER
main.server <- c("APACHE", "GSE", "MICROSOFT", "NGINX", "NONE")
# wrong SERVER
wrong.server <- c("XXXXXXXXXXXXXXXXXXXXXX", "YIPPEE-KI-YAY", "WWW.LEXISNEXIS.COM  9999", "SERVER")
# combine wrong and main SERVER
server.comb <- combine(main.server, wrong.server)
# simplify SERVER, all values not in main server or wrong server lists are set to be "OTHER", values in wrong server lists are set to be "SUSPICIOUS"
website <- website %>% 
  mutate(SERVER = as.factor(ifelse(SERVER %in% server.comb, as.character(SERVER), "OTHER"))) %>%
  mutate(SERVER = as.factor(ifelse(SERVER %in% wrong.server, "SUSPICIOUS", as.character(SERVER))))
# simplify WHOIS_COUNTRY
website <- website %>% 
  mutate(WHOIS_COUNTRY = str_replace_all(WHOIS_COUNTRY, ".*UK.*", "UK")) %>%
  mutate(WHOIS_COUNTRY = str_replace_all(WHOIS_COUNTRY, "UNITED KINGDOM", "UK")) %>%
  mutate(WHOIS_COUNTRY = str_replace_all(WHOIS_COUNTRY, "GB", "UK")) %>%
  mutate(WHOIS_COUNTRY = factor(WHOIS_COUNTRY))
main.country <- c("UK", "US", "CA", "NONE")
website <- website %>% 
  mutate(WHOIS_COUNTRY = as.factor(ifelse(WHOIS_COUNTRY %in% main.country, as.character(WHOIS_COUNTRY), "OTHER")))
# simplify CHARSET
website <- website %>% 
  mutate(CHARSET = str_replace_all(CHARSET, pattern = "ISO-8859.*", "ISO-8859")) %>%
  mutate(CHARSET = str_replace_all(CHARSET, pattern = "WINDOWS.*", "WINDOWS")) %>%
  mutate(CHARSET = as.factor(CHARSET))
website.sim <- website %>%
  filter(str_detect(website$WHOIS_REGDATE, "T"))
```

# summary
```{r}
# histograms
ggpairs(website.quant)
website.quant %>%
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram()

# log transform (need to deal with 0s later)
# website.quant <- website.full %>% mutate_if(is.numeric, log)
```

# fit model
```{r}
glm.quant <- glm(Type ~ . , data = website.train, family = binomial)
summary(glm.quant)

glm.quant.signif <- glm(Type ~ URL_LENGTH + NUMBER_SPECIAL_CHARACTERS + CONTENT_LENGTH + DIST_REMOTE_TCP_PORT, data = website.train, family = binomial)
summary(glm.quant.signif)
residualPlots(glm.quant.signif)
# predict
pred.quant.signif <- predict(glm.quant.signif, newdata = website.test, type = "response")
website.test <- website.test %>% mutate(pred.quant.signif = as.factor(ifelse(pred.quant.signif <= 0.5, 0, 1)))
accuracy.quant.signif <- mean(website.test$pred.quant.signif == website.test$Type)
```

